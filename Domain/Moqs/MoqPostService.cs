using System;
using System.Collections.Generic;
using System.Linq;
using GrislyGrotto.Core.Entities;

namespace GrislyGrotto.Core.Moqs
{
    public class MoqPostService : IPostService
    {
        private static User[] moqUsers;
        private static List<Post> moqPosts;
        private static List<Comment> moqComments;
        
        public MoqPostService()
        {
            moqUsers = new []
                           {
                               new User { FullName = "Christopher", LoginName = "havoc" },
                               new User { FullName = "Peter", LoginName = "pdc" },
                               new User { FullName = "Ben", LoginName = "odin" }
                           };

            if(moqPosts == null)
                moqPosts = new List<Post>
                               {
                                    new Post { ID = 1, User = moqUsers[0], Title = "Uncharted Adventures", Created = DateTime.Now, Status = PostStatus.Published, Content = "I borrowed Uncharted 2: Among Thieves off my boss yesterday and have just finished a full playthrough, a single 12 hour session. A good game, perhaps an excellent game, even if one with near zero replayability. Still, it feels like a movie all the way through, a proper Indiana Jones like epic (old Indiana Jones, not Crystal Skull garbage) and though there were some tricky bits, over all it has strong pacing and excellent gameplay. Cool. It was a little odd however to have two character voices voiced by two actors who were also major characters in Dragon Age. Particularly Cladia Black, of Pitch Black/Farscape/Stargate SG-1 fame, who played Chloe in this and Morrigan in Dragon Age. Ahh well. Awesome.</p><p>So now, again, I sit in the twilight of experience, with nothing to do in my immediate future. I started writing a story, but while fun with no planning it is unlikely to go anywhere. I could do some coding, that perpetual war between wanting to write or code, to try and do something meaningful. Bah. Arkham Asylum is downloading on steam, guess I'll play that when done."},
                                    new Post { ID = 2, User = moqUsers[1], Title = "On the slopes of Dragonmount", Created = DateTime.Now.AddDays(-1), Status = PostStatus.Published, Content = "I finished The Gathering Storm last night. It is now officially my favourite book in the series, by a significant margin. Right up until the very end it was totally epic, and balanced action with misery and triumph with great skill. Truly Sanderson is an excellent writer. So much happened in its crammed 750 pages, that it feels like it should have been twice the size. And now I have to wait a year, a YEAR, for the next one. At least there is a committed schedule to one a year, unlike Jordans 2-3 or that bastard George RR Martins 5 year break. I tink I will survive, but still. Also Sanderson has a blog and a progress bar, with attached RSS feeds, so at least I have something I can watch.</p><p>There are some sanderson-isms that I noticed. One thing is that he gets into the technical detail of his magic quite a bit, and there is some suggestion that the eventual revelations about the power that he will reveal will have a satisfying, almost scientific neatness to them like his system in Mistborn or Elantris. On top of that he does have this occasional tendency to have the drama and action derived from the train of thought of a character: I.e., several pages might be 'mind action', a character thinking through something and coming to a revelation. There was alot of that in Mistborn too and while generally fun to read I am not totally convinced that it is best practice. Bah. Still, legendary."},
                                    new Post { ID = 3, User = moqUsers[2], Title = "The Storm has Fallen", Created = DateTime.Now.AddDays(-2), Status = PostStatus.Published, Content = "<p>OMG! The Gathering Storm is awesome! I read, in a single sitting, a third of it last night, some 2-300 pages. In those pages there have been at least three truly epic chapters, two of Egwene and one of Rand, that surpass any in the last three books, since Dumai Wells. On top of that the book is single handedly managing to cover every major plot line, rather than focusing on just a few. Its amazing, its all totally balanced and I am enjoying every page. The way he is doing it is thus: every chapter is from a different perspective, and usually only 15-30 pages long. Some few have two perspectives, but most focus on a single character, different every time. Rand who, in the last two books has had a total of five or so chapters from his perspective, has already exceeded that in this book and with alternating perspectives from Nynaeve, Cadsuane, Aviendha and Min he is back being the main character of the series. He has also gained alot more definition, alot more character in this book, making him a pleasure to read. Though the gender rivalry is still there, enough so that it still seems the same series, it is no longer irritating as it has been shifted away from being the central theme of the plot. I am well pleased.</p><p>A book like this resurrects my faith in the series, all of the good with none of the bad. To emphasise this, I will list in no order the characters that have had a view so far in the first third, most of whom have had more than one chapter to themselves: Rand, Perrin, Mat, Nynaeve, Egwene, Gawyn Trakand (I'd almost forgotten about him), Siuan Sanche, Cadsuane, Min, Aviendha (And her, aside from being Elayne's BFF), Graendal, Rodel Ituralde, Tylee Khirgan, Tuon. Alot of plots are totally coming to a head. It is epic.</p>"},
                                    new Post { ID = 4, User = moqUsers[0], Title = "Days of Gaidon", Created = DateTime.Now.AddDays(-3), Status = PostStatus.Published, Content = "<p>I spent the weekend, more or less, rereading Knife of Dreams. I have to revise my opinion, and say that I enjoyed it. Last time I literally skipped through it, especially the long chapters of Elayne (the character I hate the most), but now, taking a step back and reading the story in isolation (i.e. not on the heels of the travesty that is 'Crossroads of Twilight') I would have to say its not bad. Even the Elayne chapters have their moments, and while I find Perrin a bit tedious, and his relationship with his wife Faile a little annoying, those chapters are good too. One thing that really helped was <a href=http://www.encyclopaedia-wot.org/>Encyclopedia WoT</a>; There are over 1880 characters in the series, and having an index to look them up, find out who they are and a chronological list of their appearances and actions is well useful. Also, when devouring such a book it is very good to know where I am, and importantly how many chapters are in a given characters perspective. I used to have a problem where I would get frustrated waiting for a certain viewpoint, like Rand's or Mat's, only to discover chapters and chapters of Elayne, Egwene and Nynaeve. Enter a page like the following, with a nice little graph: <a href='http://encyclopaedia-wot.org/books/kod/index.html'>Knife of Dreams Info</a>.</p><p>I guess a big problem I have with the later books is a) everyone is bonded with each other (meaning they can sense each others emotions) and the sharp disparity between genders. All the women are always amused and laughing at mens misfortunes, and indignant at any women misfortunes. With the power to sense emotions it is recounted as literally white or black. Complex characters like Min Farshaw have been reduced to simple and sharpy defined state machines, with several states based on how her 'man' is feeling or acting. People are more complex than that. Fortunately for these read through I was able to ignore it.</p><p>I started reading The Gathering Storm, all through the prologue in fact, and so far I am pleased. The characters and story are the same, and told in such a way that its not a jarring change. Sanderson's style IS different, but it doesn't break immersion. At the same time while Jordan would write a thirty line paragraph describing the play of light amongst the trees two miles from the battle in a scene, Sanderson describes the setting in three sentences then gets to the point. I dont have to concentrate with Sanderson, and am not worried I am missing anything as my higher brain functions shut down under an avalanche of dialog. Makes me sounda bit stupid, but fuck you! I have read and reread this bloody series four times, FOUR TIMES through over 11,000 pages of needless exposition, and having someone finally pick up the pace is a welcome breath of fresh air. I have read most of Sanderson's books (well, four out of seven odd), and he is an excellent writer. So far, the story he is written is truly high quality, even covering a chapter about Rand from the Seanchan perspective that eloquently both illustrated Rand's hardness and the Seanchan viewpoint extremely well, as well if not more so that Jordan had been doing. It also had Rand/Female interaction that wasn't a half jovial Enid Bryton ripoff, something that fills me with hope for the rest of the book. Also, given his pace, it looks like he might get two books of Jordan paced events into one, allowing the end of this series in its three books to be truly grand in stature. I have hope.</p><p>Other than reading, I played alot of Left 4 Dead 2, which is a great sequel even if plagued with a surprising and dissapointing number of bugs. Of particular note is my persisting loss of achievements, something which I find intensely irritating. Imagine, such behaviour from a Valve game on Steam!</p>"},
                                    new Post { ID = 5, User = moqUsers[1], Title = "Azurification", Created = DateTime.Now.AddDays(-4), Status = PostStatus.Published, Content = "<p>Bit of a scare yesterday. Lost access to the site, or more accurately its database. Given backups are difficult due to the nature of the hosting, and the last one I would consider reliable was probably over a year ago, this is a bit of a concern. Losing all my (and Petes) posts for a year would make me very, very angry. It has long been a concern to me, in the past I have had ways of exposing the data in the site for download, even a memorable period where I just used xml documents for all data (remember that? Badass!), as a way of getting around my perceived difficulties. The next step has two options, as I see it: Personal hosting, as in we have the site on one of our machines and publish it to the web, or Windows Azure. The first option runs against my biggest fear, that one day I will be robbed and lose all my stuff. That would be a bad day, for me and everyone around me.</p><p>Windows Azure is Microsofts answer to google apps and the like, but subtly different. Basically its web hosting, super scalable and super reliable, hosted on Microsoft servers around the world. The pricing could be painful, but as it gives me full and unadulterated access to practically everything (web server, storage and so on so forth) its the perfect solution. Plus, browney points with my superiors.</p><p>I will probably do some form of site rebuild before migration, so watch this space.</p>"},
                                    new Post { ID = 6, User = moqUsers[2], Title = "Running on fumes", Created = DateTime.Now.AddDays(-5).AddMonths(-2), Status = PostStatus.Published, Content = "<p>Been so tired today. Over the last two weeks I have been getting only around 5-6 hours sleep a night, generally due to some good games taking my time, and as a result have been gradually escalating my caffeine/sugar intake during work hours. Today it kind of came to a head, with me being literally half awake almost all day. Not good when dealing with the responsibilities that I have. Talking to an irate client when you just want to snore is an interesting experience. I guess I will just have to hope I can get a good rest tonight.</p><p>Despite my disadvantages today, I still managed to code up a really nifty code library to aid in coding against and unit testing Sharepoint, which I have posted over on AStringInEdgeWise.com. Still keeping that site going, which is good. I have agreed to start writing gaming reviews/articles again for my old editor on her new site, so thats cool. Er...can't think. This will have to be it.</p>"},
                                    new Post { ID = 7, User = moqUsers[0], Title = "Ticking off the days", Created = DateTime.Now.AddDays(-6).AddMonths(-2), Status = PostStatus.Published, Content = "<p>A long weekend, in which I somehow managed to drink something alcoholic at least once every day. I paid for this on the Saturday, with a day long hangover that was all kinds of unpleasant. My lovely girlfriend was kind enough to look after me, so thats okay, even If I was dragged almost vomiting to the supermarket (I thought fresh air and a walk would help, I was wrong). I feel that we also had a productive session on Sunday, me and Pete, where we built a simple web site using MVC and a few best practices. Unfortunately overall I kind of ran out of games and in the tailing end of my PSD found myself more often than not staring at my screen in that most painful of emotions: boredom. For one reason or another I don't tend to get bored these days, so this was particularly painful with that in mind. Bah. I have a few games on the horizon, Dragon Age in a week for example, and am downloading Red Faction Guerilla on steam at home, but due to the parcity of our connection this has thus far taken a good 20+ hours to come down, which is frustrating. I think part of the overall problem is that PSD tends to leave me with withdrawel for sensory overload: I find it difficult to play games like Baldur's Gate or Civ 4 because they are not fast enough, loud enough or all around immersive enough to fill the void. Hmm.</p><p>Anyway, back into work and my responsibilities. I am getting a little worried in that the exam for Sharepoint Elite is coming up on the horizon, but I have had little chance to study for it. Coding at home is forever painful, especially since I have not as yet come up with a good study plan. Fuckit, lets give it a go right now. I need to target:</p><ul><li>Creating custom forms for list items.</li><li>Creating roles and permissions to control visibility of lists and list items.</li><li>Work flows, creation and deployment.</li></ul><p>A painful list, but one that must be processed. I need to not only do the above, but also be proficient enough to do it on the day without access to the net. Could be problematic. Fortunately all the other stuff which I struggled with in the exam I have had ample opportunity to practice in the course of my work since, so there is that. I think perhaps even without the above I have a fairly good chance to score high, higher than I did before. However I think the last exam was heavily scaled once they realised that no one could pass it, so I might not have that caveat this time round. Hmm.</p>"},
                                    new Post { ID = 8, User = moqUsers[1], Title = "Why I Write (or plan to)", Created = DateTime.Now.AddDays(-7).AddMonths(-2), Status = PostStatus.Published, Content = "<p>Been thinking about my motivation for writing, what I want to get out of it. A complicated question, with an even more complicated answer. There are various motivations, and the question is whether they are valid enough and strong enough to actually serve as the drive behind a 400 page novel. I come to this after thinking about writing again (for the millionth time) and musing over past failures, where I've been all excited, done heaps of planning, and been fired up right up til halfway through the first paragraph, when I get bored. Why I become bored is important, especially considering that there are over 100,000 words already in this blog since its inception, proving that I have the flesh, if not the spirit, for large scale authoring.</p><p>First, the physical and mercurial: I am a good writer and enjoy the act of word smithing. Even writing these lines I attain a quiet satisfaction at each well-crafted sentence, each balanced section. In life, the things you are generally good at, the things that set you apart from those you socialise with, are things to be treasured. Secondly there is money to be made, especially in todays market. Because of a few people and a few series, the book writing industry, in particular fantasy fiction, is experiencing a revival. Ol' JK Rowling is worth 2 billion dollars, for Chrissake. Even that author of Twilight, who in my personal opinion has no grasp of character development, pacing or general believability, has earned more cash than I will in my entire career in software dev. Money money money.</p><p>On a more philosophical/spiritual plane, I have both the creative drive and the need for emotional fulfillment through fiction. My creativity is the underlying secret of my coding life, in that while to others it is a job, to me it is at least partially an opportunity to play with lego all day. I get to put together complicated structures, living and breathing programs, flick a switch and watch them claw into life. Beautiful. Writing would provide another, slightly different outlet where I am not only crafting a story, I am also constructing an entire world and the complicated inhabitants within it. Furthermore, in the creation of these inhabitants I have the opportunity to create people I can hate and love, understand and sympathise with, so there is that emotional opportunity as well.</p><p>I guess I want my books to mean something, to explore a concept or a relationship pattern. In this vein, I find it hard to put together the usual 12 steps or quest based story, which always seem more about the plot than the theme. Hmm. Anyway, might post more on this as the whim takes me.</p>"},
                                    new Post { ID = 9, User = moqUsers[2], Title = "PSD, 23rd edition", Created = DateTime.Now.AddDays(-8), Status = PostStatus.Published, Content = "<p>I finished Infamous last night. The ending and the revelation it contained was spectacular. I mean, I liked the game before, it was great, but after what you learn at the end, and how it all fits and indeed the entire motivation of the characters in the plot, I have found that my mind is in turmoil. Throughout the day I have been reminiscing on the story, considering the implications, and each has left me with a sense of haunting eerieness, much like when I contemplate the nameless one from Torment. Fascinating. Unfortunately I know it will not last, and soon enough I will be once again numb. Bah.</p><p>In the grip of Post Serial Depression (PSD) right now, and in such a state I find it hard to play anything else as I desperately seek some form of emotional fulfillment. Kind of want to do something creative, write or code (which is also writing), but in front of this damn machine I always feel the need for some form of sensory overload. I can't work in silence at the helm of this tiny little god, with its hard disks packed with shiny treasures. It is truly both a blessing and a curse.</p>"},
                                    new Post { ID = 10, User = moqUsers[0], Title = "Just some thoughts", Created = DateTime.Now.AddDays(-9), Status = PostStatus.Published, Content = "<p>Autocracy is all power in the hands of one, democracy is power in the hands of the many. So in today's quasi democracy we implement in most western countries, this means the many vote for the few who wield power. The many vote for the specific committee allowed to run the country. The committee has a couple dozen odd members (National in NZ has 58 at time of writing) who collectively, under a chairman (the Prime Minister) run this country of four million. Hmm. I guess its an interesting concept in principle, although I think it means that the many do not have power over the country, but instead a limited power to control who has power, and even then, only periodically. Possibly a good thing.</p><p>If we had 'true' democracy, then everyone would have the ability to vote on issues. I can't imagine a worse kind of hell, mainly because contrary to public belief, I would guess a good ninety percent of what you and I think and believe probably comes from someone else, be it media or trusted specialists. When the many speak, it is truly with one voice: the local news anchor. Given that of all the people in the world least qualified to rule, media personalities, hippies and close minded scientists tend to be at the top of the list, true democracy should be avoided for any time soon. Perhaps if society progressed to a more e-Caucus type of thing, with the people properly educated on a wide range of views and perspectives...no, such a thing is pointless, because in such a situation the many would still be broadly similar based on what they were exposed to.</p><p>I think the whole idea of democracy as it exists today is not to give people a voice, but to give them a sense of control. There is nothing more soul destroying as feeling like a helpless pawn under the command of others, and having the ability to vote and in some tiny way manipulate the command structure alleviates this. I don't vote generally, because I undestand how little it means, don't care about the governments actions all that much and ultimately don't have enough interest to feel qualified to make an informed decision. If I did vote it would be to a) vote National cause my Dad does, vote Labour to spite Pete, vote National First because Winston Peters cracks me up. These are not reasons for me to get out of bed on voting day I feel.</p><p>The core difference, the eminent fact that seperates our government style from autocracy, is the committee at the center, the ruling party. In the 20-50 odd members actually in power, their myriad voices and beuorocracy inspired structure prevents the excesses endemic in an Autocrat coming into play. By having them periodically removed every 4-8 years or so one like minded power can never amass enough strength to cause long lasting harm, slightly offset by the same inability to perform long lasting good. Interesting.</p><p>In summary, modern democracy is rule by the few dozen, with the vote serving as a mechanism to keep those few dozen from getting comfortable in their power and ensuring that they are regularly replaced, so that power cannot become an end in on itself.</p><p>Not too sure where I was supposed to be going with this. Bah.</p>"},
                               };

            if (moqComments == null)
                moqComments = new List<Comment>
                                  {
                                      new Comment { Author="Anonymous", Content = "Some sample comment text 1", Created = DateTime.Now.AddDays(-5) },
                                      new Comment { Author="Anonymous", Content = "Some sample comment text 2", Created = DateTime.Now.AddDays(-8) },
                                      new Comment { Author="Anonymous", Content = "Some sample comment text 3", Created = DateTime.Now.AddDays(-11) }
                                  };
        }

        public IEnumerable<Post> GetLatest(User user, DateTime fromTime, int? count, PostStatus type)
        {
            var posts = (user != null ?
                moqPosts.Where(p => p.User.Equals(user) && p.Created < fromTime && p.Status.Equals(type)).OrderByDescending(p => p.Created)
            : moqPosts.Where(p => p.Created < fromTime && p.Status.Equals(type)).OrderByDescending(p => p.Created))
            as IEnumerable<Post>;

            if (count.HasValue)
                posts = posts.Take(count.Value);

            foreach (var post in posts)
                post.Comments = moqComments;

            return posts;
        }

        public Post GetSpecific(int postID)
        {
            var post = moqPosts.SingleOrDefault(p => p.ID.Equals(postID));
            post.Comments = moqComments;
            return post;
        }

        public IEnumerable<Post> GetFromMonth(User user, int year, string monthName, PostStatus type)
        {
            var posts = user != null ?
                moqPosts.Where(p => p.User.Equals(user) && p.Created.ToString("MMMM").Equals(monthName) && p.Created.Year.Equals(year) && p.Status.Equals(type)).OrderBy(p => p.Created)
            : moqPosts.Where(p => p.Created.ToString("MMMM").Equals(monthName) && p.Created.Year.Equals(year) && p.Status.Equals(type)).OrderBy(p => p.Created);
            
            foreach (var post in posts)
                post.Comments = moqComments;

            return posts;
        }

        public IEnumerable<Post> Search(User user, string searchTerm, PostStatus type)
        {
            var posts = user != null ?
                moqPosts.Where(p => p.User.Equals(user) && (p.Title.Contains(searchTerm.ToLowerInvariant()) || p.Content.Contains(searchTerm.ToLowerInvariant())) && p.Status.Equals(type)).OrderBy(p => p.Created)
            : moqPosts.Where(p => (p.Title.ToLowerInvariant().Contains(searchTerm.ToLowerInvariant()) || p.Content.ToLowerInvariant().Contains(searchTerm.ToLowerInvariant())) && p.Status.Equals(type)).OrderBy(p => p.Created);
            
            foreach (var post in posts)
                post.Comments = moqComments;

            return posts;
        }

        public Post AddPost(Post post)
        {
            post.ID = moqPosts.Select(p => p.ID).OrderByDescending(p => p).First() + 1;
            moqPosts.Add(post);
            return post;
        }

        public void UpdatePost(Post post)
        {
            moqPosts[moqPosts.IndexOf(moqPosts.Single(p => p.ID.Equals(post.ID)))] = post;
        }

        public void DeletePost(int postID)
        {
            moqPosts.Remove(moqPosts.Single(post => post.ID.Equals(postID)));
        }

        public Dictionary<DateTime, int> GetMonthPostCounts(User user)
        {
            var returnMonths = new Dictionary<DateTime, int>();
            if(user != null)
            {
                var months = moqPosts.Where(p => p.User.Equals(user)).Select(p => new {p.Created.Year, p.Created.Month}).Distinct();
                foreach (var month in months)
                    returnMonths.Add(new DateTime(month.Year, month.Month, 1), moqPosts.Count(p => p.User.Equals(user) && p.Created.Year.Equals(month.Year) && p.Created.Month.Equals(month.Month)));
            }
            else
            {
                var months = moqPosts.Select(p => new { p.Created.Year, p.Created.Month }).Distinct();
                foreach (var month in months)
                    returnMonths.Add(new DateTime(month.Year, month.Month, 1), moqPosts.Count(p => p.Created.Year.Equals(month.Year) && p.Created.Month.Equals(month.Month)));
            }
            return returnMonths;
        }

        public void AddComment(Post post, Comment comment)
        {
            moqComments.Add(comment);
        }
    }
}